This surrogator is developed to automatically generate surrogates for unstructured reports.Surrogated files are .txt files where the annotated PHI is replaced with surrogates generated by this script, based on few rules (refer to sections below).

# Improvements from v1(July 2017)
- Used a surrogate map to record surrogate for PHI in one text, same PHI in one text will be replaced with the same surrogate
- For name surrogate, use algorithm in the description below to match name and aliases.
- For dates, use `dateutil.parser` to parse dates and can match most dates formats. All time strings in one doc shifts with one day number randomly pick from (1-730). Ages also shifted with the same day number.
- For states, match states names and their aliases.

# Usage
The surrogate generation can be run either:
- Set ```"surrogate": true``` in config file and it is run in postprocess phase in the predictpipeline.
- run ```python surrogate.py [-r] --in in_path --out out_path``` add -r for multi file under one directory. Use path of the file for one file surrogate, use directory path for multi file surrogate. Always use directory path for out path. eg. ```python surrogator.py -r  --in input/test_set --out output/surr```

# How are surrogates generated ?
For each document, create one surrogate map to record existing surrogate. For each annotated , first find if it exists in the surrogate map, return if there is already a surrogate, else generate with the rules below. [to do - add an example]

- NAME (PATIENT, DOCTOR):
    1. Find from our name dictionary to determine possible gender, if not able to determine, choose one randomly.
    2. For each document, give a number, say alpha shift, mapping one letter to another added that shift in alphabet. Then a letter map can be created (i.e. given alpha shift = 3, we have A - D, B - E so on and so forth).
    3. For each name annotated, first use 2 initial letters of first and last name (eg. JODO for John Doe). This can be used as lookup in the name mapping to find existing surrogate generated for this name in this file. 2-letters-pairs can distinguish names more accurately comparing to only storing abbr like JD, and can hit more situations comparing to full name map. If a surrogate for this name exists in our surrogate map, return this surrogate. Otherwise go on step 4. 
        - *A name can appear in several format in one file. For example John Doe can appear to be either "JD", "J Doe", "John D", "Doe, John" , "John", "Doe", "Mr. Doe" in one file. If only one initial appear in the text, we regard it as the same if that initial matches (i.e. "J D " = "JODO"). If only one name appears, we generate lookup with this part and match only this part (i.e. John = "JO  " = "JODO"). Also, if a comma appears, we reverse both names.*
    4. For each part of the name (i.e. first name and last name, if there is), find corresponding letter of its initial letter in the letter map created in step 2, randomly choose a name starting with this corresponding letter and  from the dictionary, use the same way in step 3 to get a 2-letter-pair lookup for this name, add this lookup-surrogate pair to the surrogate map. Return the surrogated name.
- DATE:
    - We apply a random date (1 day ~ 10 years) shift for each file, all dates in this file are shifted according to this shift.
        - **NOTE**: It appears that some annotated date string are mistake and cannot be parsed and shifted, these strings are left as [\*\* DATE \*\*] 
- STATE:
    - A map was create between states and their abbr., they are regarded as the same state and can be used in surrogate map lookup and surrogate replacement.
- CITY, COUNTRY, HOSPITAL, ORGANIZATION, PROFESSION:
    - Randomly choose from our dictionary
- ROOM:
    - Random(100-2000)
- ZIP:
    - Random(3000-9999)
- IDNUM:
    - random(11-19)+ R + random(10000-99999)
- BIOID:
    - random(11-19)+ N + random(10000-99999)
- AGE:
    - Shifted with the date shift in DATE as years.
- MEDICALRECORD:
    - Random(1000000-9999999)
- USERNAME:
    - Random(a-z) \* 2 + Random(0-9) \* 2
- EMAIL:
    - Random string with uuid + "@gmail.com"
- FAX, PHONE:
    - Random(01-08 + random 7 digits)
- URL:
    - www. + random 3-8 ascii letters (a-zA-Z) + .com
- DEPARTMENT:
    - Cannot find dictionary online, use departments appear in HSA gold set as dictionary. Random choose one from this dictionay.

- TODO (cannot find dictionary/format in gold set):
    - DEVICE, HEALTHPLAN, LICENSE
